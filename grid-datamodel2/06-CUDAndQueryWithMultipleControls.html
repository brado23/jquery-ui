<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Data model: CUD with multiple controls</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<script src="../jquery-1.4.4.js"></script>
	<script src="jquery.tmpl.js"></script>
	<script src="jquery.tmplPlus.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.menu.js"></script>
	<script src="../ui/jquery.ui.autocomplete.js"></script>
	<script src="grid.js"></script>
	<script src="jquery.datalink2.js"></script>
	<script src="jquery.datasource.js"></script>
	<script src="jquery.pager.js"></script>

	<script>

	$(function() {

		// A remote data source managing the contents of "genres".
		var genres = [];
		var options = $.extend({
			path: "http://odata.netflix.com/Catalog/Genres"
		}, $.dataSource.oDataSettings);
		$([ genres ]).dataSource(options);  // refresh() causes the dataSource to update the contents of the array to which it's bound.

		// A "control" (if you will) over the "genres" array.
		$([ genres ]).bind("changeArray", function () {
			$("#genreCount").text(genres.length);
		});

		// A second, familiar grid control over "genres".
		// These two controls stay in sync via the "genres" array.
		var genresGrid = $( "#genres" ).grid({
			columns: [ "Name" ],
			source: genres,
			selectMode: "single"
		}).data( "grid" );
		$.setField(genresGrid, "source", genres);  // TODO -- The widget factory deeply copies options, which loses genres.

		// TODO -- I should really wire-up grid to listen on "setField/changeField" and show master and detail
		// controls staying in sync with respect to field updates.

		// Dynamically change the filter options.
		$("#filter").autocomplete({
			source: function (term) {
				if (term.term === "") {
					$([ genres ]).dataSource().option("filter", null).refresh();
				} else {
					$([ genres ]).dataSource().option("filter", {
						property: "Name",
						operator: "Contains",
						value: term.term
					}).refresh();
				}
			},
			minLength: 0
		});

		// Do simple array mutation using "$.changeArray" in order to raise "setArray/changeArray" events.
		// Both controls are listening on these events to stay in sync with their shared data.
		$("#addGenre").click(function () {
			$.changeArray(genres, "unshift", { Name: $(this).next().val() });
		});
		$("#deleteGenre").click(function () {
			var index = $.inArray(genresGrid.selectedItem.data, genres);
			if (index >= 0) {
				$.changeArray(genres, "splice", index, 1);
			}
		});

		// Establish an initial filter substring to initially refresh the data source.
		$("#filter").val("Africa").autocomplete("search", "Africa");
	});
	</script>
</head>
<body>

<h2>Control showing genre count</h2>
<p>
Genre count: <span id="genreCount">?</span>
</p>

<h2>Filtered genres</h2>
<p>
<table id="genres">
	<thead>
		<tr>
			<th data-field="Name">Name</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</p>

<p class="ui-widget">Genres filter:<input id="filter" type="text"></input></p>

<p><input id="addGenre" type="button" value="Add:"></input><input type="text" value="African Naturalist"></input></p>

<p><input id="deleteGenre" type="button" value="Delete selected genre"></input></p>

</body>
</html>
