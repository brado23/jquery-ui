<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Data model: Query over local data</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="grid.css">
	<script src="../jquery-1.4.4.js"></script>
	<script src="jquery.tmpl.js"></script>
	<script src="jquery.tmplPlus.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.menu.js"></script>
	<script src="../ui/jquery.ui.autocomplete.js"></script>
	<script src="grid.js"></script>
	<script src="jquery.datalink2.js"></script>
	<script src="jquery.datasource.js"></script>
	<script src="jquery.pager.js"></script>

	<script>

	var developers = [
		{
			firstName: "Scott",
			lastName: "González",
			country: "USA",
			twitter: "scott_gonzalez",
			github: "scottgonzalez"
		},
		{
			firstName: "Jörn",
			lastName: "Zaefferer",
			country: "Germany",
			twitter: "bassistance",
			github: "jzaefferer"
		},
		{
			firstName: "Brad",
			lastName: "Olenick",
			country: "USA",
			twitter: "",
			github: "brado23"
		},
		{
			firstName: "Richard",
			lastName: "Worth",
			country: "USA",
			twitter: "rworth",
			github: "rdworth"
		},
		{
			firstName: "Boris",
			lastName: "Moore",
			country: "USA",
			twitter: "borismoore",
			github: "BorisMoore"
		}
	];

	$(function() {
		// We'll bind this array to a data source, which will control the array's contents.
		var queriedDevelopers = [];

		// Bind a grid to "queriedDevelopers".  The grid will react to array changes.
		// Notice that the grid has no awareness of a data source.
		var developersGrid = $( "#developers" ).grid({
			columns: [ "firstName", "lastName", "country" ],
			source: queriedDevelopers
		}).data( "grid" );
		$.setField(developersGrid, "source", queriedDevelopers);  // TODO -- The widget factory deeply copies options, which loses queriedDevelopers.

		// The data source bound to "queriedDevelopers" controls its contents.
		// The "inputArray" option causes the data source to apply query options locally on refresh().
		// We'll dynamically reconfigure the query options on this data source to change the contents 
		// of "queriedDevelopers".
		$([ queriedDevelopers ]).dataSource({
			inputArray: developers
		});  // refresh() causes the data source to update the contents of the array to which it's bound.

		// Bind a paging control to the data source managing "queriedDevelopers".  The paging control 
		// determines the paging options on the data source and refreshes the data source on paging clicks.
		// Notice that the pager has no awareness of the "developers" array, since it doesn't need it.
		$("#developersPager").pager({
			dataSource: $([ queriedDevelopers ]).dataSource(),
			pageSize: 3
		});

		// Dynamically change the filter options.
		$("#filter").autocomplete({
			source: function (term) {
				$("#developersPager").pager("setPage", { pageNumber: 0, refresh: false });  // Changing sort resets to page zero.

				if (term.term === "") {
					$([ queriedDevelopers ]).dataSource().option("filter", null).refresh();
				} else {
					$([ queriedDevelopers ]).dataSource().option("filter", {
						property: "firstName",
						operator: "Contains",
						value: term.term
					}).refresh();
				}
			},
			minLength: 0
		});

		// Dynamically change the sort options.
		var sorted;
		$("#sortDevelopers").click(function () {
			$("#developersPager").pager("setPage", { pageNumber: 0, refresh: false });  // Changing sort resets to page zero.

			if (sorted) {
				$([ queriedDevelopers ]).dataSource().option("sort", null).refresh();
			} else {
				$([ queriedDevelopers ]).dataSource().option("sort", {
					property: "firstName",
					direction: "asc"
				}).refresh();
			}
			sorted = !sorted;
			$("#sortDevelopers").val(sorted ? "Remove sort" : "Sort developers");
		});

		// Refresh our now-configured data source, so that "queriedDevelopers" is populated
		// in a way that reflects the current query options.
		$([ queriedDevelopers ]).dataSource().refresh();
	});
	</script>
</head>
<body>


<h2>Query over local data</h2>
<p>
<table id="developers">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</p>

<p><div id="developersPager"></div></p>

<p class="ui-widget">Developers filter:<input id="filter" type="text" name="filter"></input></p>

<p><input id="sortDevelopers" type="button" value="Sort developers"></input></p>

</body>
</html>
