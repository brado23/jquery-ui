<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid with Observable Editable Data</title>
	<link rel="stylesheet" href="../../themes/base/jquery.ui.all.css"/>
	<link rel="stylesheet" href="../grid.css"/>
	<link href="editable.css" rel="stylesheet"/>
	<script src="../../jquery-1.5.1.js"></script>
	<script src="../../external/jquery.tmpl.js"></script>
	<script src="../../ui/jquery.ui.core.js"></script>
	<script src="../../ui/jquery.ui.widget.js"></script>
	<script src="../../ui/jquery.ui.button.js"></script>
	<script src="jquery.observable.js" type="text/javascript"></script>
	<script src="../datasource.js"></script>
	<script src="../datasource-local.js"></script>
	<script src="../grid.js"></script>
	<script src="../pager.js"></script>

	<script>

	var developers, developersDataGrid, selectedItem, adding = false;
	$.ajax({
		dataType: "json",
		url: "../developers.json",
		async: false,
		success: function( result ) {
			developers = result;
		}
	});

	$( function() {
		developersDataGrid = $( "#developers-data" ).grid({
			selectMode: "single",
			columns: [ "firstName", "lastName", "country" ],
			source: developers,
			select: function( event, args ) {
				onSelectionChange( $( args.selected ).tmplItem().data );
			}
		}).data( "grid" );

		$("#addDeveloper" ).click( function () {
			adding = true;
			var insertAt = selectedItem ? 
				$.inArray( selectedItem, developers ) : 
				developers.length,
				addedData = {
					firstName: "",
					lastName: "",
					country: ""
				};
			$.observable( developers ).insert( insertAt, addedData );
			adding = false;

			onSelectionChange( addedData );
		});

		$( "#deleteDeveloper" ).click( function () {
			deleteSelectedDeveloper();
		});

		$( "#developerDetail" )
			.delegate( "#okBtn", "click", function () {
				// Commit entire form content to data model with one API call.
				$.observable( selectedItem ).setProperty( $( "#developerDetail input" ).serializeArray() );

				$( "#developerDetail" ).empty();

				// The grid currently re-renders a row even for property updates, so we lose selection
				// styling here and need to explicitly reapply.
				var selectedItemEl = $.grep( developersDataGrid.rowElements(), function( itemEl ) {
					return $( itemEl ).tmplItem().data === selectedItem;
				} )[ 0 ];
				$( selectedItemEl ).addClass( "grid-selected-row");
			})
			.delegate( "#deleteBtn", "click", function () {
				deleteSelectedDeveloper();
			});

		function onSelectionChange( newSelectedItem ) {
			if ( selectedItem ) {
				var selectedItemEl = $.grep( developersDataGrid.rowElements(), function( itemEl ) {
					return $( itemEl ).tmplItem().data === selectedItem;
				} )[ 0 ];
				$( selectedItemEl ).removeClass( "grid-selected-row" );
			}

			selectedItem = newSelectedItem;
			$( "#developerDetail" ).empty();

			if ( newSelectedItem ) {
				var newSelectedItemEl = $.grep( developersDataGrid.rowElements(), function( itemEl ) {
					return $( itemEl ).tmplItem().data === newSelectedItem;
				} )[ 0 ];
				$( newSelectedItemEl ).addClass( "grid-selected-row");

				$.tmpl( $("#detailViewTemplate"), newSelectedItem )
					.appendTo( "#developerDetail" );
			}
		}

		function deleteSelectedDeveloper() {
			if ( selectedItem ) {
				var index = $.inArray( selectedItem, developers );
				$.observable( developers ).remove( index );

				onSelectionChange( index >= developers.length ? developers[ developers.length - 1 ] : developers[ index ] );
			}
		}
	});
	</script>
</head>
<body>

<h1>Grid with editable data</h1>

<p>
	<button id="addDeveloper" >Insert developer</button>
	<button id="deleteDeveloper" >Delete selected developer</button>
</p>

<table id="developers-data">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div id="developerDetail" class="editperson"></div>

<script id="detailViewTemplate" type="text/x-jquery-tmpl">
	<div>
		<div class="title">{{if adding}}Add{{else}}Edit{{/if}} Person</div>
		<div><input name="firstName" value="${firstName}"/></div>
		<div><input name="lastName" value="${lastName}"/></div>
		<div><input name="country" value="${country}"/></div>
		<span id="okBtn" >OK</span>
		<span id="deleteBtn" >Delete</span>
	</div>
</script>

</body>
</html>
