<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid with Observable Editable Data</title>
	<link rel="stylesheet" href="../../themes/base/jquery.ui.all.css"/>
	<link rel="stylesheet" href="../grid.css"/>
	<link href="editable.css" rel="stylesheet"/>
	<script src="../../jquery-1.5.1.js"></script>
	<script src="../../external/jquery.tmpl.js"></script>
	<script src="../../ui/jquery.ui.core.js"></script>
	<script src="../../ui/jquery.ui.widget.js"></script>
	<script src="../../ui/jquery.ui.button.js"></script>
	<script src="jquery.observable.js" type="text/javascript"></script>
	<script src="../datasource.js"></script>
	<script src="../datasource-local.js"></script>
	<script src="../grid.js"></script>
	<script src="../pager.js"></script>

	<script>

	var developers, developersDataSource, developersDataGrid, selectedItem, adding = false;
	$.ajax({
		dataType: "json",
		url: "../developers.json",
		async: false,
		success: function( result ) {
			developers = result;
		}
	});

	$( function() {
		developersDataSource = $.ui.localDatasource({
			input: developers
		});

		developersDataGrid = $( "#developers-data" ).grid({
			selectMode: "single",
			columns: [ "firstName", "lastName", "country" ],
			source: developersDataSource,
			select: function( event, args ) {
				onSelectChange( args.selected );
			}
		}).data( "grid" );

		developersDataSource.refresh();

		$("#addDeveloper" ).click( function () {
			adding = true;
			var insertAt = selectedItem ? 
				$.inArray( selectedItem, developersDataGrid.rowElements() ) : 
				developersDataSource.toArray().length,
				addedData = {
					firstName: "",
					lastName: "",
					country: ""
				};
			$.observable( developersDataSource.toArray() ).insert( insertAt, addedData );
			adding = false;

			onSelectChange( developersDataGrid.rowElements()[ insertAt ] );
		});

		$( "#deleteDeveloper" ).click( function () {
			deleteSelectedDeveloper();
		});

		$( "#developerDetail" )
			.delegate( "#okBtn", "click", function () {
				// Commit entire form content to data model with one API call.
				var selectedItemData = $( selectedItem ).tmplItem().data;
				$.observable( selectedItemData ).setProperty( $( "#developerDetail input" ).serializeArray() );

				$( "#developerDetail" ).empty();
			})
			.delegate( "#deleteBtn", "click", function () {
				deleteSelectedDeveloper();
			});

		function onSelectChange( newSelectedItem ) {
			if ( selectedItem ) {
				$( selectedItem ).removeClass( "grid-selected-row" );
			}

			selectedItem = newSelectedItem;
			$( "#developerDetail" ).empty();

			if ( newSelectedItem ) {
				$( newSelectedItem ).addClass( "grid-selected-row");

				var selectedItemData = $( newSelectedItem ).tmplItem().data;
				$.tmpl( $("#detailViewTemplate"), selectedItemData )
					.appendTo( "#developerDetail" );
			}
		}

		function deleteSelectedDeveloper() {
			if ( selectedItem ) {
				var index = $.inArray( selectedItem, developersDataGrid.rowElements() );
				$.observable( developersDataSource.toArray() ).remove( index );

				selectedItem = null;
				var rowElements = developersDataGrid.rowElements();
				onSelectChange( index >= rowElements.length ? rowElements[ rowElements.length - 1] : rowElements[ index ] );
			}
		}
	});
	</script>
</head>
<body>

<h1>Grid with editable data</h1>

<p>
	<button id="addDeveloper" >Insert developer</button>
	<button id="deleteDeveloper" >Delete selected developer</button>
</p>

<table id="developers-data">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div id="developerDetail" class="editperson"></div>

<script id="detailViewTemplate" type="text/x-jquery-tmpl">
	<div>
		<div class="title">{{if adding}}Add{{else}}Edit{{/if}} Person</div>
		<div><input name="firstName" value="${firstName}"/></div>
		<div><input name="lastName" value="${lastName}"/></div>
		<div><input name="country" value="${country}"/></div>
		<span id="okBtn" >OK</span>
		<span id="deleteBtn" >Delete</span>
	</div>
</script>

</body>
</html>
