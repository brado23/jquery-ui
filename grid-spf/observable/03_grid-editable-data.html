<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Editable Data</title>
	<link rel="stylesheet" href="../../themes/base/jquery.ui.all.css"/>
	<link rel="stylesheet" href="../grid.css"/>
	<link href="editable.css" rel="stylesheet"/>
	<script src="../../jquery-1.5.1.js"></script>
	<script src="jquery.observable.js" type="text/javascript"></script>
	<script src="jquery.render.js" type="text/javascript"></script>
	<script src="jquery.views.js" type="text/javascript"></script>
	<script src="../../ui/jquery.ui.core.js"></script>
	<script src="../../ui/jquery.ui.widget2.js"></script>
	<script src="../grid.js"></script>

	<script>

	var developersInput, developersDataGrid, selectedItem, adding = false;

	$.ajax({
		dataType: "json",
		url: "../developers.json",
		async: false,
		success: function( result ) {
			developersInput = result;
		}
	});

	$( function() {
		developersDataGrid = $( "#developers-data" ).grid({
			selectMode: "single",
			columns: [ "firstName", "lastName", "country" ],
			source: developersInput,
			select: onSelectChange
		}).data( "grid" );

		developersDataGrid.select( 0 );

		function onSelectChange( event, args ) {
			if ( itemInvalid( selectedItem ) ) {
				$.observable( developersInput ).splice( selectedItem.index, 1 );
			}
			if ( args.selectedItem ) {
				selectedItem = args.selectedItem;
				$( "#developerDetail" )
					.html(
						$( "#detailViewTemplate" ).render( selectedItem.data )
					)
					.dataLink( selectedItem.data );
			} else {
				$( "#developerDetail" ).empty();
				selectedItem = null;
			}
		}

		function itemInvalid( item ) {
			var data = item && item.data;
			return data && (data.firstName.length + data.lastName.length + data.country.length) === 0;
		}

		function deleteSelectedDeveloper() {
			var selectedItem = developersDataGrid.options.selectedItem;
			if ( selectedItem ) {
				var prevIndex = selectedItem.index;
				if ( itemInvalid( selectedItem )) {
					prevIndex++; // Just need to set selection. Deletion will occur in onSelectChange
				} else {
					$.observable( developersInput ).splice( prevIndex, 1 );
				}
				developersDataGrid.select( prevIndex );
			}
		}

		$("#addDeveloper" ).click( function () {
			if ( itemInvalid( selectedItem )) {
				return; // Current added developer has not be committed
			}
			adding = true;
			var selectedItem = developersDataGrid.options.selectedItem,
				insertAt = selectedItem ? selectedItem.index : developersDataGrid.options.viewItems.length,
				addedData = {
					firstName: "",
					lastName: "",
					country: ""
				};
			$.observable( developersInput ).splice( insertAt, 0, addedData );
			developersDataGrid.select( insertAt );
			adding = false;
		});

		$( "#deleteDeveloper" ).click( function () {
			deleteSelectedDeveloper();
		});

		$( "#developerDetail" )
			.delegate( "#okBtn", "click", function () {
				developersDataGrid.select();
			})
			.delegate( "#deleteBtn", "click", function () {
				deleteSelectedDeveloper();
			});
	});
	</script>
</head>
<body>

<h1>Grid with editable data</h1>

<p>
	<button id="addDeveloper" >Insert developer</button>
	<button id="deleteDeveloper" >Delete selected developer</button>
</p>
<table id="developers-data">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div id="developerDetail" class="editperson"></div>

<script id="detailViewTemplate" type="text/x-jquery-tmpl">
	<div>
		<div class="title">{{if adding}}Add{{else}}Edit{{/if}} Person</div>
		<div><input data-jq-linkfrom="firstName" data-jq-linkto="firstName" value="${firstName}"/></div>
		<div><input data-jq-linkfrom="lastName" data-jq-linkto="lastName" value="${lastName}"/></div>
		<div><input data-jq-linkfrom="country" data-jq-linkto="country" value="${country}"/></div>
		<span id="okBtn" >OK</span>
		<span id="deleteBtn" >Delete</span>
	</div>
</script>

</body>
</html>
