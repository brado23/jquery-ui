<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Editing, Inline Grid</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="../grid-spf/grid.css">
	<script src="../jquery-1.5.1.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../external/jquery.mousewheel-3.0.4.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.spinner.js"></script>
	<script src="../ui/jquery.ui.position.js"></script>
	<script src="../ui/jquery.ui.tooltip.js"></script>
	<script src="../grid-spf/datasource.js"></script>
	<script src="../grid-spf/datasource-local.js"></script>
	<script src="../grid-spf/grid.js"></script>
	<script src="../grid-spf/pager.js"></script>
	<script src="editor.js"></script>
	<script src="localstore.js"></script>
	<script src="helpers.js"></script>
	<script src="jquery.observable.js"></script>
	<script src="jquery.datatracker.js"></script>
	<script>
	var store = $.demos.localstore( {
		key: "grid-editing-developers",
		initial: "../grid-spf/developers.json"
	});
	var localDevelopers = store.load();

	$(function() {
		var developers = $.ui.localDatasource({
			input: localDevelopers,
			paging: {
				limit: 8
			}
		});

		var tracker = $.dataTracker( localDevelopers ),
			trackerChanged = function() {
				console.log("saving");
				store.save( localDevelopers );
				// We could examine "tracker" to determine what changed here in order
				// to do an incremental save.

				styleChangedRows($( "#developers-local tr" ));
				// We can be sure that this selector is in sync with localDevelopers, since
				// the data-tracker issues its events _after_ any changes to localDevelopers.
				// Data-tracker does this by hooking $.observable.
			};
		$( [ tracker.insertedItems, tracker.removedItems, tracker.updatedItems ] ).bind( "arrayChange", trackerChanged );

		$( "#developers-inserted" ).grid({
			selectMode: "none",
			columns: [ "firstName", "lastName", "country" ],
			source: tracker.insertedItems
		});
		$( "#developers-removed" ).grid({
			selectMode: "none",
			columns: [ "firstName", "lastName", "country" ],
			source: tracker.removedItems
		});
		$( "#developers-updated" ).grid({
			selectMode: "none",
			columns: [ "firstName", "lastName", "country" ],
			source: tracker.updatedItems
		});

		var grid = $.ui.grid( {
			source: developers.toArray(),
			rowAdded: function( event, elem ) {
				$( elem ).find( "td:not(:has(button))" ).each( function() {
					var th = $( this ).parents( "table:first" ).find( "th" ).eq( this.cellIndex ),
						field = th.data( "field" );
					$( this ).editor({
						type: th.data( "type" ),
						submit: function( event, ui ) {
							var object = $( this ).tmplItem().data;
							var oldValue = get(object, field);
							$.observable( object ).setProperty( field, ui.value );
						}
					});
				});

				styleChangedRows( $( elem ) );
				// We can be sure that data-tracker has accurately tracked changes to localDevelopers
				// by the time this event is issued (due to a localDevelopers change).
				// Data-tracker hooks $.observable to ensure it can synchronize its state before data
				// change events are issued.
			}
		}, "#developers-local" );

		// TODO find a better way to add markup to the generated row template
		grid.options.rowTemplate = grid.options.rowTemplate.substring( 0, grid.options.rowTemplate.length - 35 )
			+ "<button class='edit'>Edit</button></td>"
			+ "<td><button class='remove'>Remove</button></td></tr>";

		var developer;
		var editForm = $( "#editForm" ).hide().submit( function( event ) {
			event.preventDefault();
			$.observable( developer ).setProperty( $( this ).serializeArray() );
			editForm.hide();
		});
		grid.element.delegate( "button.edit", "click", function() {
			developer = $( this ).tmplItem().data;
			$( "#edit-tmpl" ).tmpl( meta(developer) ).appendTo( editForm.find("fieldset").empty() );
			editForm.show();
		});
		grid.element.delegate( "button.remove", "click", function() {
			var developer = $( this ).tmplItem().data;
			var index = localDevelopers.indexOf( developer );
			$.observable( localDevelopers ).remove( index );

			// This could be treated differently.  We could change the localDataSource impl
			// to listen for "arrayChange" on its input and automatically do this refresh.
			// App code could similiarly listen on "arrayChange" on localDevelopers to refresh.
			// The benefit of these alternatives is that they work if localDevelopers is
			// changed by code that isn't this handler.
			developers.refresh();
		});

		$( "#pageDevelopers" ).pager({
			source: developers
		});

		$( "#addDeveloper" ).click( function() {
			// add at front so that it becomes visible without paging
			$.observable( localDevelopers ).insert( 0, {
				firstName: "Peter",
				lastName: "Pan",
				country: "Unknown",
				bitcoins: 0,
				random: {
					value: 0
				}
			});

			// See refresh comment above.
			developers.refresh();
		});

		$("form").tooltip();

		developers.refresh();

		function styleChangedRows( rows ) {
			var changedClass = "grid-selected-row";
			rows.removeClass( changedClass ).filter( function() {
				var developer = $( this ).tmplItem().data;
				return $.inArray( developer, tracker.insertedItems ) >= 0 ||
					$.inArray( developer, tracker.removedItems ) >= 0 ||
					$.inArray( developer, tracker.updatedItems ) >= 0;
			}).addClass( changedClass );
		};
	});
	</script>
	<style>
	</style>
</head>
<body>

<h1>Grids with editable local datasource</h1>

<div style="float: left;">

<h2>local data source</h2>
<p id="pageDevelopers">
	<button data-page="first">First</button>
	<button data-page="prev">Prev</button>
	<button data-page="prevStep">-1</button>
	<span>
		Page <input class="current" size="4"/>/<span class="total">0</span>,
		Total records <span class="totalRecords">0</span>
	</span>
	<button data-page="nextStep">+1</button>
	<button data-page="next">Next</button>
	<button data-page="last">Last</button>
</p>
<table id="developers-local">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
			<th data-field="bitcoins" data-type="number">Bitcoins</th>
			<th data-field="random.value" data-type="number">Random</th>
			<th>Edit</th>
			<th>Remove</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div>
	<button id="addDeveloper">Insert new developer</button>
</div>
<form id="editForm">
	<fieldset>
	</fieldset>
	<input type="submit" value="Save changes" />
</form>

</div>

<div style="float: right;">

<h1>Change-tracking</h1>

<h2>Inserted developers</h2>

<table id="developers-inserted">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<h2>Removed developers</h2>

<table id="developers-removed">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<h2>Updated developers</h2>

<table id="developers-updated">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

</div>

<script id="edit-tmpl" type="text/x-jquery-tmpl">
{{if $.isArray(value)}}
	<ul>
		{{each(index, valueX) value}}
			<li><input type="text" name="${name}" placeholder="${label}" value="${valueX}" title="${label}" /></li>
		{{/each}}
	</ul>
{{else}}
	<input type="text" name="${name}" placeholder="${label}" value="${value}" title="${label}" />
{{/if}}
</script>

</body>
</html>
